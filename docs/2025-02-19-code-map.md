---
type: code-map
date: 2025-02-19
---

# Codebase Map

## Summary
A TypeScript-based AI coding agent designed to run in a REPL loop, utilizing subagents and tools to explore, edit, and verify code. It uses a flexible prompt system defined in Markdown and supports OpenRouter for LLM inference.

## Architecture
The application is built around a central `runTurn` loop in `src/agent.ts`.
- **Core Loop**: A REPL in `src/index.ts` captures user input, maintains history, and calls `runTurn`.
- **Agent Logic**: `runTurn` communicates with an LLM (via `src/lib/api.ts`), handles tool calling cycles, and supports recursion via subagents (`agentRunner`).
- **Tooling**: Tools are modular functions in `src/tools/`, exposed to the LLM via a definition schema.
- **Prompts**: Defined as Markdown files with frontmatter in `src/prompts/`, serving as configuration for different Agent personas (e.g., Feature Planner, Tech Researcher).

## Main Modules
- **Agent Core (`src/agent.ts`)**: Handles the conversation loop, tool execution, and context management.
- **Tools (`src/tools/`)**:
    - **Filesystem**: `list_files`, `read_file`, `write_file`, `replace_in_file`.
    - **System**: `bash` (Unix command execution), `git_diff`.
    - **Search**: `search_files` (ripgrep wrapper).
- **API Client (`src/lib/api.ts`)**: Handles communication with OpenRouter/LLM APIs.
- **Prompt Manager (`src/prompts/`)**: Loads and parses agent personas from Markdown files.

## Critical Issues (Priority Order)
1. **Security**: The `bash` tool (`src/tools/system.ts`) allows arbitrary command execution. This is intended for the agent's power but poses a significant risk if the agent is hijacked or runs destructive commands.
2. **Data Integrity**: `replace_in_file` (`src/tools/files.ts`) relies on simple string replacement. While it checks for uniqueness, it reads the entire file into memory, which could fail for very large files.
3. **Usability**: `search_files` clips results at 50 matches. This might hide relevant results in large codebases without paging logic.

## Data Model
No database is used. State is maintained in-memory (message history) and persisted via filesystem logs.

### Key Types
- **Message**: Standard ChatML format (`role`, `content`, `tool_calls`).
- **Prompt**: Configuration for an agent (`name`, `systemPrompt`, `tools`).

## Type Definitions
- **Messaging**: `src/lib/types.ts` (`Message`, `CompletionResponse`).
- **Tools**: `src/tools/types.ts` (`CommandExecutor`, `AgentRunner`).
- **Prompts**: `src/prompts/index.ts` (`Prompt`).

## File Map

### src/index.ts
- **Main Entry Point**: Sets up the REPL, logging, and initializes the session.
- **Dependencies**: `agent.ts`, `lib/api.ts`, `prompts/index.ts`
- **Notes**: Manually handles session logging to `.session_logs/`.

### src/agent.ts
- **Methods**:
    - `runTurn(history: Message[], apiCaller?: ApiCaller, toolExecutor?: CommandExecutor, tools?: any[]): Promise<TurnResult>` - Executes one turn of conversation, handling multiple tool steps if necessary.
- **Dependencies**: `lib/api.ts`, `tools/index.ts`
- **Notes**: Contains the recursion logic for subagents.

### src/lib/api.ts
- **Methods**:
    - `fetchModelStats(): Promise<ModelStats | null>` - Fetches current model pricing.
    - `callLLM(messages: Message[], tools?: any[]): Promise<CompletionResponse>` - calls OpenRouter API.
- **Dependencies**: Native `fetch`.

### src/tools/index.ts
- **Exports**: `executeTool` dispatcher and `TOOLS` definition array.
- **Methods**:
    - `executeTool(name: string, args: any, bashExecutor?: CommandExecutor, agentRunner?: AgentRunner): Promise<string>` - Routes tool calls to specific implementations.

### src/tools/files.ts
- **Methods**:
    - `listFiles(dirPath: string): Promise<string>` - Lists directory contents.
    - `readFileContent(path: string, start?: number, limit?: number): Promise<string>` - Reads file with line limits.
    - `writeFileContent(path: string, content: string): Promise<string>` - Overwrites file.
    - `replaceInFile(path: string, oldText: string, newText: string): Promise<string>` - String replacement.

### src/tools/search.ts
- **Methods**:
    - `searchFiles(query: string, path?: string, includeNodeModules?: boolean): Promise<string>` - Runs `rg`.

### src/tools/system.ts
- **Methods**:
    - `runBash(command: string, executor: CommandExecutor): Promise<string>` - Executes shell commands.
- **Notes**: Uses `bun` shell `$`.

### src/tools/git.ts
- **Methods**:
    - `gitDiff(executor: CommandExecutor): Promise<string>` - wrapper for `git diff`.

### src/prompts/index.ts
- **Methods**:
    - `getPrompt(name: string): Prompt` - Loads prompt by name from cache/disk.
- **Notes**: Parses frontmatter from `.md` files in `src/prompts/`. `loadPrompts` is internal.

### tests/agent.test.ts
- **Notes**: Tests `runTurn` logic with mocked API and tools. Verifies tool call loops and final responses.
